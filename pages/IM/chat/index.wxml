<view class="chatWrap"  bindtap="resetView">
  <chat-bubble mineUserInfo="{{mineUserInfo}}"></chat-bubble>
  <chat-header bindputUp="headerPutUp" mineUserInfo="{{mineUserInfo}}" othersUserInfo="{{othersUserInfo}}"></chat-header>
  <view class="systemHint" wx:if="{{false}}">TA特别想认识你，缘分来了就不要错过哟~</view>
  <debutWord bindselectResult="selectResult" type="debutWord" bindtapMpre="bindtapMpre" wx:if="{{false}}"></debutWord>
  <view class="chatArea">
    <view class="scrollView">
      <view class="message-list">
        <view class="message-box" wx:for="{{messageList}}" wx:key="id">
          <view class="time" wx:if="{{!index || (index > 0 && item.imData.timestamp - messageList[index - 1].imData.timestamp > 1000 * 60)}}">{{filters.activeTime(item.imData.timestamp)}}</view>
          <view class="message-item {{item.imFromUser.uid === mineUserInfo.id ? 'mine' : 'others'}}" id="msg{{index}}">
            <view class="avatar">
              <i-image src="{{item.imFromUser.uid === mineUserInfo.id ? item.imFromUser.avatarUrl : item.imToUser.avatarUrl}}"></i-image>
            </view>
            <view 
              class="message-content {{parse.setMsgType(item.msgType)}} msgCon{{index}}" 
              bindlongpress="longpress" 
              data-object="{{item}}" 
              data-class="msgCon{{index}}"
              data-index="{{index}}"
              >
              <block wx:if="{{item.msgType === 'RC:TxtMsg'}}">
              <view class="text"><rich-text nodes="{{filters.setEmoji(item.imData.content.content, imagePath)}}" space="emsp"></rich-text></view>
              </block>
              <block wx:if="{{item.msgType === 'RC:ImgMsg'}}">
                <msg-image message="{{item.imData.content}}"></msg-image>
              </block>
              <block wx:if="{{item.msgType === 'RC:VcMsg'}}">
                <msg-audio own="{{item.imFromUser.uid === mineUserInfo.id}}" message="{{item.imData.content}}"></msg-audio>
              </block>
              <view 
                class="longpress"
                style="{{longpressData.style}}"
                wx:if="{{longpressData.index === index}}"
                >
                <i class="icon" style="{{longpressData.iconStyle}}"></i>
                <text class="textBtn">复制</text>
                <text class="textBtn">撤回</text>
                <text class="textBtn">删除</text>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>
  <view id="bottomBlock" style="height:1rpx"></view>
  <chat-footer id="footer" selectIndex="{{selectIndex}}" bindselectType="selectType" bindsendMsg="sendMsg" vkey="{{othersUserInfo.vkey}}" mineUserInfo="{{mineUserInfo}}"></chat-footer>
</view>
<wxs src="../../../utils/filters.wxs" module="filters" />

<wxs module="parse">
  module.exports = {
    hidden: function (type, selectIndex) {
      switch (type) {
        case 'console-area':
          return [null, 1, 2].indexOf(selectIndex) !== -1
          break
        case 'record':
          return [null, 1, 2, 3, 4].indexOf(selectIndex) !== -1
          break
        case 'emoji':
          return [null, 0, 1, 2, 4].indexOf(selectIndex) !== -1
          break
        case 'debutWord':
          return [null, 0, 1, 2, 3].indexOf(selectIndex)  !== -1
          break
      }
    },
    setStyle : function(type, textHeight, selectIndex){
      var consoleHeight = [0, 3, 4].indexOf(selectIndex) !== -1 ? 400 : 0
      switch (type) {
        case 'chatArea':
          return 'height: calc(148rpx + ' + textHeight + 'px + ' + consoleHeight + 'rpx)';
          break
        case 'textarea':
          return 'height:' + textHeight + 'px;';
          break
      }
    },
    setMsgType : function( type ){
      switch (type) {
        case 'RC:TxtMsg':
          return 'text'
          break
        case 'RC:ImgMsg':
          return 'img'
          break
      }
    }
  }
</wxs>